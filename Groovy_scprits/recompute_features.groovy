removeMeasurements(qupath.lib.objects.PathDetectionObject, "Delaunay: Num neighbors", "Delaunay: Mean distance", "Delaunay: Median distance", "Delaunay: Max distance", "Delaunay: Min distance", "Delaunay: Mean triangle area", "Delaunay: Max triangle area", "Cluster mean: Delaunay: Num neighbors", "Cluster mean: Delaunay: Mean distance", "Cluster mean: Delaunay: Median distance", "Cluster mean: Delaunay: Max distance", "Cluster mean: Delaunay: Min distance", "Cluster mean: Delaunay: Mean triangle area", "Cluster mean: Delaunay: Max triangle area", "Smoothed: 25 µm: Delaunay: Num neighbors", "Smoothed: 25 µm: Delaunay: Mean distance", "Smoothed: 25 µm: Delaunay: Median distance", "Smoothed: 25 µm: Delaunay: Max distance", "Smoothed: 25 µm: Delaunay: Min distance", "Smoothed: 25 µm: Delaunay: Mean triangle area", "Smoothed: 25 µm: Delaunay: Max triangle area", "Smoothed: 25 µm: Cluster mean: Delaunay: Num neighbors", "Smoothed: 25 µm: Cluster mean: Delaunay: Mean distance", "Smoothed: 25 µm: Cluster mean: Delaunay: Median distance", "Smoothed: 25 µm: Cluster mean: Delaunay: Max distance", "Smoothed: 25 µm: Cluster mean: Delaunay: Min distance", "Smoothed: 25 µm: Cluster mean: Delaunay: Mean triangle area", "Smoothed: 25 µm: Cluster mean: Delaunay: Max triangle area", "Smoothed: 50 µm: Delaunay: Num neighbors", "Smoothed: 50 µm: Delaunay: Mean distance", "Smoothed: 50 µm: Delaunay: Median distance", "Smoothed: 50 µm: Delaunay: Max distance", "Smoothed: 50 µm: Delaunay: Min distance", "Smoothed: 50 µm: Delaunay: Mean triangle area", "Smoothed: 50 µm: Delaunay: Max triangle area", "Smoothed: 50 µm: Cluster mean: Delaunay: Num neighbors", "Smoothed: 50 µm: Cluster mean: Delaunay: Mean distance", "Smoothed: 50 µm: Cluster mean: Delaunay: Median distance", "Smoothed: 50 µm: Cluster mean: Delaunay: Max distance", "Smoothed: 50 µm: Cluster mean: Delaunay: Min distance", "Smoothed: 50 µm: Cluster mean: Delaunay: Mean triangle area", "Smoothed: 50 µm: Cluster mean: Delaunay: Max triangle area");
removeMeasurements(qupath.lib.objects.PathDetectionObject, "Smoothed: 25 µm: Area µm^2", "Smoothed: 25 µm: Length µm", "Smoothed: 25 µm: Circularity", "Smoothed: 25 µm: Solidity", "Smoothed: 25 µm: Max diameter µm", "Smoothed: 25 µm: Min diameter µm", "Smoothed: 25 µm: Hematoxylin: Mean", "Smoothed: 25 µm: Hematoxylin: Median", "Smoothed: 25 µm: Hematoxylin: Min", "Smoothed: 25 µm: Hematoxylin: Max", "Smoothed: 25 µm: Hematoxylin: Std.Dev.", "Smoothed: 25 µm: DAB: Mean", "Smoothed: 25 µm: DAB: Median", "Smoothed: 25 µm: DAB: Min", "Smoothed: 25 µm: DAB: Max", "Smoothed: 25 µm: DAB: Std.Dev.", "Smoothed: 25 µm: Distance to annotation with Outside Pia µm", "Smoothed: 25 µm: Distance to annotation with SliceContour µm", "Smoothed: 25 µm: Distance to annotation with S1HL µm", "Smoothed: 25 µm: Cluster mean: Area µm^2", "Smoothed: 25 µm: Cluster mean: Length µm", "Smoothed: 25 µm: Cluster mean: Circularity", "Smoothed: 25 µm: Cluster mean: Solidity", "Smoothed: 25 µm: Cluster mean: Max diameter µm", "Smoothed: 25 µm: Cluster mean: Min diameter µm", "Smoothed: 25 µm: Cluster mean: Hematoxylin: Mean", "Smoothed: 25 µm: Cluster mean: Hematoxylin: Median", "Smoothed: 25 µm: Cluster mean: Hematoxylin: Min", "Smoothed: 25 µm: Cluster mean: Hematoxylin: Max", "Smoothed: 25 µm: Cluster mean: Hematoxylin: Std.Dev.", "Smoothed: 25 µm: Cluster mean: DAB: Mean", "Smoothed: 25 µm: Cluster mean: DAB: Median", "Smoothed: 25 µm: Cluster mean: DAB: Min", "Smoothed: 25 µm: Cluster mean: DAB: Max", "Smoothed: 25 µm: Cluster mean: DAB: Std.Dev.", "Smoothed: 25 µm: Cluster mean: Distance to annotation with Outside Pia µm", "Smoothed: 25 µm: Cluster mean: Distance to annotation with SliceContour µm", "Smoothed: 25 µm: Cluster mean: Distance to annotation with S1HL µm", "Smoothed: 25 µm: Cluster size", "Smoothed: 25 µm: Nearby detection counts", "Smoothed: 50 µm: Area µm^2", "Smoothed: 50 µm: Length µm", "Smoothed: 50 µm: Circularity", "Smoothed: 50 µm: Solidity", "Smoothed: 50 µm: Max diameter µm", "Smoothed: 50 µm: Min diameter µm", "Smoothed: 50 µm: Hematoxylin: Mean", "Smoothed: 50 µm: Hematoxylin: Median", "Smoothed: 50 µm: Hematoxylin: Min", "Smoothed: 50 µm: Hematoxylin: Max", "Smoothed: 50 µm: Hematoxylin: Std.Dev.", "Smoothed: 50 µm: DAB: Mean", "Smoothed: 50 µm: DAB: Median", "Smoothed: 50 µm: DAB: Min", "Smoothed: 50 µm: DAB: Max", "Smoothed: 50 µm: DAB: Std.Dev.", "Smoothed: 50 µm: Distance to annotation with Outside Pia µm", "Smoothed: 50 µm: Distance to annotation with SliceContour µm", "Smoothed: 50 µm: Distance to annotation with S1HL µm", "Smoothed: 50 µm: Cluster mean: Area µm^2", "Smoothed: 50 µm: Cluster mean: Length µm", "Smoothed: 50 µm: Cluster mean: Circularity", "Smoothed: 50 µm: Cluster mean: Solidity", "Smoothed: 50 µm: Cluster mean: Max diameter µm", "Smoothed: 50 µm: Cluster mean: Min diameter µm", "Smoothed: 50 µm: Cluster mean: Hematoxylin: Mean", "Smoothed: 50 µm: Cluster mean: Hematoxylin: Median", "Smoothed: 50 µm: Cluster mean: Hematoxylin: Min", "Smoothed: 50 µm: Cluster mean: Hematoxylin: Max", "Smoothed: 50 µm: Cluster mean: Hematoxylin: Std.Dev.", "Smoothed: 50 µm: Cluster mean: DAB: Mean", "Smoothed: 50 µm: Cluster mean: DAB: Median", "Smoothed: 50 µm: Cluster mean: DAB: Min", "Smoothed: 50 µm: Cluster mean: DAB: Max", "Smoothed: 50 µm: Cluster mean: DAB: Std.Dev.", "Smoothed: 50 µm: Cluster mean: Distance to annotation with Outside Pia µm", "Smoothed: 50 µm: Cluster mean: Distance to annotation with SliceContour µm", "Smoothed: 50 µm: Cluster mean: Distance to annotation with S1HL µm", "Smoothed: 50 µm: Cluster size", "Smoothed: 50 µm: Nearby detection counts");
removeMeasurements(qupath.lib.objects.PathDetectionObject, "Cluster mean: Area µm^2", "Cluster mean: Length µm", "Cluster mean: Circularity", "Cluster mean: Solidity", "Cluster mean: Max diameter µm", "Cluster mean: Min diameter µm", "Cluster mean: Hematoxylin: Mean", "Cluster mean: Hematoxylin: Median", "Cluster mean: Hematoxylin: Min", "Cluster mean: Hematoxylin: Max", "Cluster mean: Hematoxylin: Std.Dev.", "Cluster mean: DAB: Mean", "Cluster mean: DAB: Median", "Cluster mean: DAB: Min", "Cluster mean: DAB: Max", "Cluster mean: DAB: Std.Dev.", "Cluster mean: Distance to annotation with Outside Pia µm", "Cluster mean: Distance to annotation with SliceContour µm", "Cluster mean: Distance to annotation with S1HL µm", "Cluster size");


// Delaunay connections are not stored in the measurement table, they need to be removed manually
def imageData = getCurrentImageData()

def connections = imageData.getProperties().get("OBJECT_CONNECTIONS")
if (connections) {
	connections.clear()
}

// Recompute the features
def outsidePia = getAnnotationObjects().find{it.getPathClass()==getPathClass("Outside Pia")}

setSelectedObject(outsidePia)

detectionToAnnotationDistances(true)

selectAnnotations()

// For some images SH1L is contains inside SliceContour and that raises an error with the Delaunay plugin
// Need to fix it
def S1HL = getAnnotationObjects().find{it.getPathClass()==getPathClass("S1HL")}
def SliceContour = getAnnotationObjects().find{it.getPathClass()==getPathClass("SliceContour")}
if (SliceContour) {
	SliceContour.clearChildObjects()
}
if (S1HL) {
	addObject(S1HL)
}
fireHierarchyUpdate()


runPlugin('qupath.opencv.features.DelaunayClusteringPlugin', '{"distanceThresholdMicrons": 0.0,  "limitByClass": false,  "addClusterMeasurements": false}')
runPlugin('qupath.lib.plugins.objects.SmoothFeaturesPlugin', '{"fwhmMicrons": 50.0,  "smoothWithinClasses": false}')


// Remove Cluster feature as all cells get the same and unique cluster values 
removeMeasurements(qupath.lib.objects.PathDetectionObject, "Cluster mean: Area µm^2", "Cluster mean: Length µm", "Cluster mean: Circularity", "Cluster mean: Solidity", "Cluster mean: Max diameter µm", "Cluster mean: Min diameter µm", "Cluster mean: Hematoxylin: Mean", "Cluster mean: Hematoxylin: Median", "Cluster mean: Hematoxylin: Min", "Cluster mean: Hematoxylin: Max", "Cluster mean: Hematoxylin: Std.Dev.", "Cluster mean: DAB: Mean", "Cluster mean: DAB: Median", "Cluster mean: DAB: Min", "Cluster mean: DAB: Max", "Cluster mean: DAB: Std.Dev.", "Cluster mean: Distance to annotation with Outside Pia µm", "Cluster mean: Distance to annotation with SliceContour µm", "Cluster mean: Distance to annotation with S1HL µm", "Cluster size");

